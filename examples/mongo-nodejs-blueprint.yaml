tosca_definitions_version: cloudify_dsl_1_3

imports:
  - https://raw.githubusercontent.com/cloudify-cosmo/cloudify-manager/4.1/resources/rest-service/cloudify/types/types.yaml
  # - https://raw.githubusercontent.com/cloudify-incubator/cloudify-kubernetes-plugin/1.2.0.dev0/plugin.yaml
  - https://raw.githubusercontent.com/cloudify-incubator/cloudify-kubernetes-plugin/4e473b05f18f5f67fb183a54fcac1094e9e79087/plugin.yaml

inputs:

  configuration_file_content:
    type: string

node_templates:

  nodejs_replication_controller:
    type: cloudify.kubernetes.resources.ReplicationController
    properties:
      definition:
        file:
          resource_path: resources/web-controller.yaml
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: k8s
      - type: cloudify.relationships.depends_on
        target: nodejs_service

  nodejs_service:
    type: cloudify.kubernetes.resources.Service
    properties:
      definition:
        file:
          resource_path: resources/web-service.yaml
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: k8s
      - type: cloudify.relationships.depends_on
        target: mongo_replication_controller

  mongo_replication_controller:
    type: cloudify.kubernetes.resources.ReplicationController
    properties:
      definition:
        file:
          resource_path: resources/mongo-controller.yaml
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: k8s
      - type: cloudify.relationships.depends_on
        target: mongo_service

  mongo_service:
    type: cloudify.kubernetes.resources.Service
    properties:
      definition:
        file:
          resource_path: resources/mongo-service.yaml
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: k8s

  k8s:
    type: cloudify.kubernetes.nodes.Master
    properties:
      configuration:
        file_content: { get_input: configuration_file_content }
